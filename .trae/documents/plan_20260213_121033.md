# 代码优化方案 - 解决GPU内存占用过高问题

## 问题分析

GPU内存占用过高可能由以下原因导致：
1. **对话历史过长**：每次对话都会将消息添加到历史记录，导致内存持续增长
2. **API请求并发处理**：多个API请求同时处理可能导致内存占用峰值过高
3. **资源未及时释放**：请求处理完成后，相关资源可能未及时释放
4. **模型加载方式**：Ollama模型的加载和使用方式可能不够优化

## 优化方案

### 1. 对话历史管理优化

- **实现对话历史限制**：设置最大对话轮数，超过限制后自动清理旧消息
- **添加对话历史清理功能**：允许用户手动清理历史记录
- **按会话管理历史**：为每个API Key创建独立的对话历史，避免交叉污染

### 2. API请求处理优化

- **实现请求队列**：限制并发处理的请求数量
- **添加请求超时机制**：避免长时间运行的请求占用资源
- **优化响应处理**：确保响应处理完成后及时释放相关资源

### 3. 资源管理优化

- **实现资源自动释放**：在请求处理完成后明确释放相关资源
- **添加内存监控**：定期检查内存使用情况，在内存占用过高时采取措施
- **优化数据结构**：使用更高效的数据结构存储对话历史和API Key信息

### 4. 配置优化

- **添加内存使用限制配置**：允许用户根据硬件情况设置合理的内存使用限制
- **添加并发请求数配置**：允许用户根据硬件情况设置合理的并发请求数

## 技术实现要点

- 使用`collections.deque`实现固定大小的对话历史队列
- 使用`threading.Semaphore`实现请求并发控制
- 添加定期内存检查和清理机制
- 优化API Key和对话历史的存储结构
- 确保所有异常情况下都能正确释放资源

## 预期效果

- GPU内存占用将保持在合理范围内
- 系统稳定性将得到提升
- 即使在高并发情况下也能正常运行
- 用户体验将更加流畅